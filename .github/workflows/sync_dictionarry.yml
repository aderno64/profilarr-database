name: Sync Group Tiers from Dictionarry

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.REPO_PAT }}
          ref: stable

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Generate File Mappings and Download Sources
        id: setup
        run: |
          mkdir -p source_files
          # This JSON file is the single source of truth for file mappings
          cat << EOF > file_map.json
          {
            "custom_formats/WEB-DL Tier 1.yml": "regex_patterns/Dictionarry WEB Tier 01.yml",
            "custom_formats/WEB-DL Tier 2.yml": "regex_patterns/Dictionarry WEB Tier 02.yml",
            "custom_formats/WEB-DL Tier 3.yml": "regex_patterns/Dictionarry WEB Tier 03.yml",
            "custom_formats/WEB-DL Tier 4.yml": "regex_patterns/Dictionarry WEB Tier 04.yml",
            "custom_formats/WEB-DL Tier 5.yml": "regex_patterns/Dictionarry WEB Tier 05.yml",
            "custom_formats/2160p Quality Tier 1.yml": "regex_patterns/Dictionarry UHD Tier 01.yml",
            "custom_formats/2160p Quality Tier 2.yml": "regex_patterns/Dictionarry UHD Tier 02.yml",
            "custom_formats/2160p Quality Tier 3.yml": "regex_patterns/Dictionarry UHD Tier 03.yml",
            "custom_formats/2160p Quality Tier 4.yml": "regex_patterns/Dictionarry UHD Tier 04.yml",
            "custom_formats/2160p Quality Tier 5.yml": "regex_patterns/Dictionarry UHD Tier 05.yml",
            "custom_formats/2160p Quality Tier 6.yml": "regex_patterns/Dictionarry UHD Tier 06.yml",
            "custom_formats/2160p Quality Tier 7.yml": "regex_patterns/Dictionarry UHD Tier 07.yml",
            "custom_formats/1080p Quality Tier 1.yml": "regex_patterns/Dictionarry HD Tier 01.yml",
            "custom_formats/1080p Quality Tier 2.yml": "regex_patterns/Dictionarry HD Tier 02.yml",
            "custom_formats/1080p Quality Tier 3.yml": "regex_patterns/Dictionarry HD Tier 03.yml",
            "custom_formats/1080p Quality Tier 4.yml": "regex_patterns/Dictionarry HD Tier 04.yml",
            "custom_formats/1080p Quality Tier 5.yml": "regex_patterns/Dictionarry HD Tier 05.yml"
          }
          EOF
          
          # Install jq for robust JSON parsing
          sudo apt-get update && sudo apt-get install -y jq
          
          # FIX: Set IFS to newline to properly handle paths with spaces from jq output
          IFS=$'\n'
          
          echo "Starting download of source files..."
          for source in $(jq -r 'keys_unsorted | .[]' file_map.json); do
            
            # Skip empty lines if they occur
            if [ -z "$source" ]; then
              continue
            fi

            # Use Bash string replacement to replace all spaces with %20.
            # Double quotes are CRITICAL here to preserve the string before replacement.
            url_path="${source// /%20}"
            
            # Base URL uses the /stable/ branch
            DOWNLOAD_URL="https://raw.githubusercontent.com/Dictionarry-Hub/database/stable/$url_path"
            
            echo "Attempting to download: $DOWNLOAD_URL"

            # Use --fail and ensure the URL is double-quoted
            curl --fail -sS -L -o "source_files/$(basename "$source")" "$DOWNLOAD_URL"
          done
          
          # Reset IFS to its default value
          unset IFS
          echo "All source files downloaded successfully."

      - name: Run Sync Script
        run: python .github/scripts/sync_release_groups.py file_map.json

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add regex_patterns/*.yml
          # Check if there are any changes staged for commit
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore(sync): Update release group patterns"
            git push
          fi
