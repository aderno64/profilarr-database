name: Sync Upstream Changes (rebuild)

on:
  schedule:
    - cron: "0 3 * * *"   # run daily at 3AM UTC
  workflow_dispatch:       # allow manual trigger from Actions tab

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout your repo (rebuild branch)
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
          ref: rebuild   # work only on your "rebuild" branch

      - name: Add upstream repo
        run: |
          git remote add upstream https://github.com/johman10/profilarr-trash-guides.git
          git fetch upstream

      - name: Merge upstream changes (prefer mine)
        id: merge
        run: |
          git checkout rebuild
          # Try merge; prefer "ours" if conflicts
          if git merge upstream/main -X ours --no-edit; then
            echo "merged=true" >> $GITHUB_OUTPUT
          else
            echo "merged=false" >> $GITHUB_OUTPUT
          fi

      - name: Show new commits pulled in
        if: steps.merge.outputs.merged == 'true'
        run: |
          echo "### Commits merged from upstream:" 
          git log HEAD@{1}..HEAD --oneline || echo "No new commits"

      - name: Push changes back to rebuild
        if: steps.merge.outputs.merged == 'true'
        run: |
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/sweatyeggs69/profilarr.git rebuild
